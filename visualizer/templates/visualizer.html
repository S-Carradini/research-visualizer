{% extends "base.html" %}
{% load static %}

<!-- Header block -->
{% block header %}
<link rel="stylesheet" type="text/css" href="{% static 'css/v_network_graph_style.css' %}" />
{% endblock %}

<!-- Content block -->
{% block content %}
<section v-cloak id="visualizer" class="p10">

    <!------------->
    <!-- Loading -->
    <!------------->

    <template v-if="loadingPage">
        <div class="p10 mt10">
            Loading...
        </div>
    </template>

    <!-------------------->
    <!-- Search results -->
    <!-------------------->

    <div v-else-if="searchResults">
        <!-- Breadcrumbs -->
        <div v-if="source">
            <a @click="exitSearch">search</a> > <a @click="exitCategory">"${ search.query }"</a> > <a @click="exitClassification">${ categoryName(category) }</a> > <a @click="exitSource">${ classificationName(classification) }</a> > ${ sourceName(source) }
        </div>
        <div v-else-if="classification">
            <a @click="exitSearch">search</a> > <a @click="exitCategory">"${ search.query }"</a> > <a @click="exitClassification">${ categoryName(category) }</a> > ${ classificationName(classification) }
        </div>
        <div v-else-if="category">
            <a @click="exitSearch">search</a> > <a @click="exitCategory">"${ search.query }"</a> > ${ categoryName(category) }
        </div>
        <div v-else>
            <a @click="exitSearch">search</a> > "${ search.query }"
        </div>

        <!-- Errors -->
        <div v-if="errors.length > 0">
            <div v-for="error in errors">
                <div>${ error }</div>
            </div>
        </div>

        <!-- Fourth-level search results: entries for classification & source -->
        <div v-if="source">
            <!-- TODO: Turn this into a component -->
            <div v-if="classificationEntries">
                <table>
                    <tr>
                        <td>Document Type</td>
                        <td>Title</td>
                        <td>First Author</td>
                    </tr>
                    <tr v-for="entry in classificationEntries" :key="entry.scopus_id" @click="enterEntry(entry)">
                        <td>
                            <!-- TODO: Translate to human-readable -->
                            ${entry.document_type}
                        </td>
                        <td>
                            ${entry.title}
                        </td>
                        <td>
                            ${entry.first_author}
                        </td>
                    </tr>
                </table>
                <div v-if="moreEntries" @click="fetchMoreSearchEntries">Load more entries</div>
            </div>
            <!-- Entry modal -->
            <div v-if="entry" class="posFixed fbColCtrCtr bgMask" style="z-index: 20000">
                <div class="posRel bgMid" style="width: 100%; max-width: 640px; max-height: 100%;">
                    <div @click="exitEntry">
                        X
                    </div>
                    <div>
                        ${ entry.publication_name }
                    </div>
                    <div>
                        ${ entry.title }
                    </div>
                    <div>
                        ${ entry.first_author }
                    </div>
                    <div>
                        ${ entry.document_type }
                    </div>
                    <div>
                        DOI: ${ entry.doi }
                    </div>
                    <div>
                        Scopus ID: ${ entry.scopus_id }
                    </div>
                    <div>
                        ${ entry.abstract }
                    </div>
                </div>
            </div>
        </div>

        <!-- Third-level search results: sources for classification -->
        <div v-else-if="classification">
            <bar-chart v-if="!isEmpty(chartData)" :chart-data="chartData" @chart-click="enterSource"></bar-chart>
        </div>

        <!-- First-level search results: categories for search query -->
        <!-- Second-level search results: classifications for category -->
        <template v-else>
            <network-graph v-if="!isEmpty(spokeNodes)" :spoke-nodes="spokeNodes" :event-handlers="networkGraphEventHandlers"></network-graph>
        </template>
    </div>

    <!---------------------->
    <!-- Search selection -->
    <!---------------------->

    <template v-else>
        <div class="p10 mt10">
            <p>Enter a search query to generate new results or browse existing search results.</p>
            <p class="ml10"><span class="fwBold">PRO TIP:</span> When exploring search results, don't use your browser's back button. Instead, use the breadcrumbs at the top of the page to navigate backward.</p>
            <p class="ml10"><span class="fwBold">PRO TIP:</span> If pending searches don't seem to ever start, make sure the worker is running.</p>
        </div>

        <!-- Search bar -->
        <div class="p10 pb20">
            <div class="mt10 mb10 fwBold">New Search:</div>
            <input v-model=query type="text" style="min-width:300px; max-width:600px;"></input>
            <a @click.prevent="initiateSearch" class="btn btnDrk ml10">Search</a>
        </div>

        <!-- Pending searches -->
        <div class="p10 pb20 bgLight">
            <div class="mt10 mb10 fwBold">Pending Searches:</div>
            <table v-if="searchesPending.length">
                <tr>
                    <td class="pr20">Query</td>
                    <td class="pr20">Categories</td>
                    <td class="pr20">Job Queued At</td>
                    <td class="pr20">Job Status</td>
                    <td class="pr20">Progress</td>
                </tr>
                <tr v-for="search in searchesPending">
                    <td class="pr20">${ search.query }</td>
                    <td class="pr20">${ getCategoriesDisplay(search) }</td>
                    <td class="pr20">${ formatDate(search.job.enqueued_at) }</td>
                    <td class="pr20">${ search.job.status }</td>
                    <td class="pr20">${ search.finished_categories.length} of ${search.categories.length} categories</td>
                </tr>
            </table>
            <div v-else>
                No pending searches
            </div>
        </div>

        <!-- Completed searches -->
        <div class="p10 pb20">
            <div class="mt10 mb10 fwBold">Completed Searches:</div>
            <table v-if="searchesCompleted.length">
                <tr>
                    <td class="pr20">Query</td>
                    <td class="pr20">Categories</td>
                    <td class="pr20">Finished At</td>
                </tr>
                <tr v-for="search in searchesCompleted">
                    <td class="pr20"><a @click.prevent="selectSearch(search)">${ search.query }</a></td>
                    <td class="pr20">${ getCategoriesDisplay(search) }</td>
                    <td class="pr20">${ formatDate(search.finished_at) }</td>
                </tr>
            </table>
            <div v-else>
                No completed searches
            </div>
        </div>
    </template>

</section>
{% endblock %}

<!-- Page-Specific JS, uncompressed -->
{% block bottomjs_uncompressed %}
<script>
    // Translate django variables to JS variables
</script>
{% endblock %}

<!-- Page-Specific JS, compressed -->
{% block bottomjs_compressed %}
<script defer type="module" src="{% static 'js/visualizer.js' %}"></script>
{% endblock %}